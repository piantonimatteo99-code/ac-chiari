/**
 * This ruleset is designed around a family-centric data model.
 * A "Famiglia" is identified by a unique address and contains members.
 * Access is primarily granted to the head of the household (capofamiglia).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // User Profile Rules
    // ----------------------------------------------------------------------
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      // Disallow list/delete for privacy and data integrity.
      allow list, delete: if false;
    }

    // ----------------------------------------------------------------------
    // Family Rules
    // ----------------------------------------------------------------------

    /**
     * @description Secures the 'famiglie' collection. A family document is identified by
     * a composite key derived from its address.
     * Reading a family document is allowed if the requesting user is the head of that family.
     * Writing (create/update) is allowed for the head of the family.
     */
    match /famiglie/{famigliaId} {
      // Allow read if user's UID matches the uidCapofamiglia in the document
      allow get: if isSignedIn() && resource.data.uidCapofamiglia == request.auth.uid;

      // Temporarily allow any signed-in user to list families.
      // This will be refined later.
      allow list: if isSignedIn();
      
      // Allow create/update if the user is the head of household
      allow write: if isSignedIn() && request.resource.data.uidCapofamiglia == request.auth.uid;
      
      // Deleting a whole family is a sensitive operation, disable from client.
      allow delete: if false;
      
      /**
       * @description Secures the 'membri' sub-collection within each family.
       * The head of the household has full control over the members of their family.
       */
      match /membri/{membroId} {
        // canAccessParentFamily checks if the user trying to access the subcollection
        // is the same one who would be allowed to write the parent document.
        // This works even if the parent document does not exist yet (on create).
        function canAccessParentFamily() {
          let isCapofamiglia = request.auth.uid == request.resource.data.uidCapofamiglia;
          let existingCapofamiglia = get(/databases/$(database)/documents/famiglie/$(famigliaId)).data.uidCapofamiglia;
          
          return isSignedIn() && (isCapofamiglia || request.auth.uid == existingCapofamiglia);
        }

        // Allow read/list if the user is the designated head of the family.
        // This rule now correctly handles the creation case where the parent doc doesn't exist yet.
        allow read, list: if isSignedIn() && (get(/databases/$(database)/documents/famiglie/$(famigliaId)).data.uidCapofamiglia == request.auth.uid);
        allow write, delete: if isSignedIn() && (get(/databases/$(database)/documents/famiglie/$(famigliaId)).data.uidCapofamiglia == request.auth.uid);
      }
    }
  }
}
